# ğŸš€ RISC-V ä¸ HDL å­¦ä¹ é¡¹ç›®

[ [English](README.md) | ä¸­æ–‡ ]

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªä¸“æ³¨äº RISC-V æ¶æ„å’Œç¡¬ä»¶æè¿°è¯­è¨€ï¼ˆHDLï¼‰çš„å­¦ä¹ é¡¹ç›®ï¼Œç‰¹åˆ«åœ°ï¼Œä½¿ç”¨ Chisel è¿›è¡Œæ ¸å¿ƒè®¾è®¡ï¼Œä½¿ç”¨ C++/Verilator è¿›è¡Œä»¿çœŸã€‚

### ğŸŒŸ ç‰¹æ€§
*   **RISC-V æ ¸å¿ƒ**: ä½¿ç”¨ Chisel å®ç°ã€‚
*   **ä»¿çœŸå™¨**: åŸºäº C++ çš„ä»¿çœŸå™¨ï¼Œä½¿ç”¨ Verilator å¤„ç† HDL æ ¸å¿ƒã€‚
*   **æ±‡ç¼–æµ‹è¯•**: ä¸€å¥— RISC-V æ±‡ç¼–æµ‹è¯•ç¨‹åºã€‚
*   **DockeråŒ–å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨ Docker å’Œ Docker Compose è½»æ¾æ­å»ºä¸€è‡´çš„æ„å»ºç¯å¢ƒã€‚
*   **Makefile è‡ªåŠ¨åŒ–**: ç®€åŒ–çš„æ„å»ºå’Œæµ‹è¯•å‘½ä»¤ã€‚

### ğŸ“‚ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ Dockerfile                 # Docker æ„å»ºæ–‡ä»¶ï¼ˆæ„å»ºå¼€å‘ä¸è¿è¡Œç¯å¢ƒï¼‰
â”œâ”€â”€ docker-compose.yml         # Docker Compose é…ç½®æ–‡ä»¶ï¼ˆåè°ƒæœåŠ¡å¯åŠ¨ï¼‰
â”œâ”€â”€ Makefile                   # æ„å»ºè„šæœ¬ç»Ÿä¸€å…¥å£ï¼ˆåŒ…å« build/test/clean ç­‰ä»»åŠ¡ï¼‰
â”œâ”€â”€ build.mill                 # Mill æ„å»ºå·¥å…·è„šæœ¬ï¼ˆç”¨äº Scala/Chiselï¼‰
â”œâ”€â”€ cli.py                     # äº¤äº’å¼å‘½ä»¤è¡Œå·¥å…·ï¼ˆä½¿ç”¨ Typer + Questionary + Richï¼‰
â”‚
â”œâ”€â”€ README.md                  # è‹±æ–‡ç‰ˆè¯´æ˜æ–‡æ¡£
â”œâ”€â”€ README_zh.md               # ä¸­æ–‡ç‰ˆè¯´æ˜æ–‡æ¡£
â”œâ”€â”€ LICENSE                    # é¡¹ç›®å¼€æºè®¸å¯è¯
â”œâ”€â”€ TODO.md                    # å¾…åŠäº‹é¡¹åˆ—è¡¨å’Œå¼€å‘è®¡åˆ’
â”‚
â”œâ”€â”€ docs/                      # é¡¹ç›®æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ update-log.md          # æ›´æ–°æ—¥å¿—
â”‚
â”œâ”€â”€ assets/                    # æ ¸å¿ƒé…ç½®èµ„æº
â”‚   â””â”€â”€ core_config.json       # é…ç½®æ–‡ä»¶ï¼šæ ¸å¿ƒæ¨¡å—å‚æ•°
â”‚
â”œâ”€â”€ scripts/                   # è¾…åŠ©è„šæœ¬ç›®å½•
â”‚   â””â”€â”€ batched_test.py        # å¹¶è¡Œè¿è¡Œ RISC-V æ±‡ç¼–æµ‹è¯•çš„è„šæœ¬
â”‚
â”œâ”€â”€ tests/                     # æµ‹è¯•ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ asmtests/              # æ±‡ç¼–æµ‹è¯•æºç åŠé“¾æ¥è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ general.ld
â”‚   â”‚   â””â”€â”€ src/*.S
â”‚   â”œâ”€â”€ clock/                 # æ—¶é’Ÿæ¨¡æ‹Ÿç›¸å…³å·¥å…·
â”‚   â””â”€â”€ riscv-tests/           # Git å­æ¨¡å—ï¼šRISC-V å®˜æ–¹ ISA æµ‹è¯•é›†
â”‚
â”œâ”€â”€ libs/                      # å¤–éƒ¨ä¾èµ–ï¼ˆGit å­æ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ capstone/              # Capstone åæ±‡ç¼–å¼•æ“å­æ¨¡å—ï¼ˆç”¨äºæŒ‡ä»¤è§£æï¼‰
â”‚   â””â”€â”€ cxxopts/               # C++ å‘½ä»¤è¡Œå‚æ•°è§£æåº“ï¼ˆç”¨äºä»¿çœŸå™¨ CLIï¼‰
â”‚
â”œâ”€â”€ emulator/                  # Verilator é©±åŠ¨çš„æµ‹è¯•å¹³å°ï¼ˆéå®Œæ•´ä»¿çœŸå™¨ï¼‰
â”‚   â”œâ”€â”€ assets/                # ROM æ„å»ºç›¸å…³æ–‡ä»¶ï¼ˆå¼•å¯¼ç¨‹åºã€è®¾å¤‡æ ‘ç­‰ï¼‰
â”‚   â””â”€â”€ src/                   # æµ‹è¯•å¹³å° C++ æºç 
â”‚       â”œâ”€â”€ dpi/               # SystemVerilog DPI æ¥å£å¤´æ–‡ä»¶
â”‚       â””â”€â”€ slaves/            # æ¨¡æ‹Ÿå¤–è®¾ï¼ˆRAMã€UART ç­‰ï¼‰
â”‚
â”œâ”€â”€ src/                       # RISC-V å¤„ç†å™¨çš„ Chisel æºç 
â”‚   â”œâ”€â”€ main/scala/markorv/    # ä¸»è¦å¤„ç†å™¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ backend/           # æ‰§è¡Œå•å…ƒï¼ˆALUã€ä¹˜é™¤æ³•ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ frontend/          # å–æŒ‡ã€è¯‘ç ã€åˆ†æ”¯é¢„æµ‹
â”‚   â”‚   â”œâ”€â”€ manage/            # é‡å‘½å/è°ƒåº¦/å¯„å­˜å™¨æ–‡ä»¶ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ bus/               # AXI æ€»çº¿æ¥å£
â”‚   â”‚   â”œâ”€â”€ cache/             # ç¼“å­˜å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config/            # é…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ exception/         # å¼‚å¸¸/ä¸­æ–­å¤„ç†æœºåˆ¶
â”‚   â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ test/scala/markorv/    # Scala ç¼–å†™çš„å•å…ƒæµ‹è¯•
â”‚
â”œâ”€â”€ project/
â”‚   â””â”€â”€ build.properties       # Mill æ„å»ºå±æ€§æ–‡ä»¶
â””â”€â”€ mill/                      # Mill ç›¸å…³å·¥å…·ç›®å½•
```

### ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

æœ¬é¡¹ç›®ä½¿ç”¨ Docker åŒ–çš„å¼€å‘ç¯å¢ƒä»¥ç¡®ä¿ä¸€è‡´æ€§å’Œä¾¿æ·æ€§ã€‚

**å…ˆå†³æ¡ä»¶:**
*   Docker å¼•æ“ï¼ˆ18.09 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
*   Docker Compose
*   SSH å®¢æˆ·ç«¯
*   æ‚¨çš„ SSH å…¬é’¥ï¼ˆé€šå¸¸æ˜¯ `~/.ssh/id_rsa.pub`ï¼‰ã€‚å¦‚æœªç”Ÿæˆï¼Œè¯·ä½¿ç”¨å‘½ä»¤ `ssh-keygen -t rsa -b 4096`ã€‚

**æ­¥éª¤:**

1.  **å…‹éš†é¡¹ç›®ä»“åº“ï¼š**
    ```bash
    git clone https://github.com/marko1616/marko-riscv.git
    cd marko-riscv
    ```

2.  **å‡†å¤‡ SSH å…¬é’¥ä½œä¸º Secretï¼š**
    Dockerfile ä½¿ç”¨æ‚¨çš„ SSH å…¬é’¥æ¥å…è®¸æ— å¯†ç ç™»å½•å®¹å™¨ï¼Œè¯·é€šè¿‡ BuildKit çš„ secret mount å®‰å…¨ä¼ å…¥ã€‚

    > é¦–å…ˆç¡®ä¿å¯ç”¨äº† BuildKit æ„å»ºæ”¯æŒï¼š
    ```bash
    export DOCKER_BUILDKIT=1
    ```

3.  **æ„å»º Docker é•œåƒï¼š**
    ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼ˆè¯·æ ¹æ®éœ€è¦è°ƒæ•´ä»£ç†åœ°å€æ˜¯å¦å¯ç”¨ä»£ç†å’Œè·¯å¾„ç­‰ï¼‰ï¼š

    ```bash
    docker build \
        --build-arg USE_MIRROR=true \
        --build-arg PROXY="<your_proxy_url>" \
        --secret id=ssh_pub_key,src=~/.ssh/id_rsa.pub \
        -t your-dev-env-image .
    ```

4.  **å¯åŠ¨å¼€å‘ç¯å¢ƒï¼š**
    ä½¿ç”¨ Docker Compose å¯åŠ¨å®¹å™¨ï¼š
    ```bash
    docker-compose up -d
    ```

5.  **è¿æ¥å¼€å‘ç¯å¢ƒï¼š**
    ä½¿ç”¨ SSH è¿æ¥å®¹å™¨ï¼š
    ```bash
    ssh build-user@localhost -p 8022
    ```

    æ‚¨ç°åœ¨å·²è¿›å…¥å®¹å™¨çš„ `/home/build-user` ç›®å½•ï¼Œé¡¹ç›®ä»£ç æŒ‚è½½åœ¨ `/home/build-user/code`ã€‚

6.  **å®¹å™¨å†…åˆå§‹è®¾ç½®ï¼š**
    å‚è§ä¸‹æ–¹è¯´æ˜ï¼Œåœ¨å®¹å™¨å†…æ‰§è¡Œç›¸å…³å¼€å‘ä¾èµ–çš„å®‰è£…ä¸é…ç½®ã€‚

### ğŸ—ï¸ æ„å»ºé¡¹ç›®

æ‰€æœ‰æ„å»ºå‘½ä»¤éƒ½åº”åœ¨ **Docker å®¹å™¨å†…** çš„ `/home/build-user/code` ç›®å½•ä¸­è¿è¡Œã€‚

*   **åˆå§‹åŒ–/æ›´æ–°å­æ¨¡å—å¹¶æ„å»º Capstone:**
    ```bash
    make init
    ```
    (è¿™ä¹Ÿä¼šæ„å»ºä»¿çœŸå™¨æ‰€éœ€çš„ Capstone åº“ã€‚)

*   **ä» Chisel ç”Ÿæˆ Verilog å¹¶ç¼–è¯‘ C++ ä»¿çœŸå™¨:**
    æ­¤å‘½ä»¤é¦–å…ˆä½¿ç”¨ `mill` ä» Chisel æºæ–‡ä»¶ç”Ÿæˆ Verilogï¼Œç„¶åä½¿ç”¨ Verilator ç¼–è¯‘ Verilog ä»¥åŠ C++ ä»¿çœŸå™¨æºæ–‡ä»¶ã€‚
    ```bash
    make compile
    ```
    ä»¿çœŸå™¨å¯æ‰§è¡Œæ–‡ä»¶å°†æ˜¯ `obj_dir/VMarkoRvCore`ã€‚

*   **ç”Ÿæˆæ±‡ç¼–æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶:**
    å°† `tests/asmtst/src/*.S` ä¸­çš„æ±‡ç¼–æµ‹è¯•ç¼–è¯‘æˆ `.elf` æ–‡ä»¶ã€‚
    ```bash
    make gen-tests
    ```
    è¾“å‡ºçš„ ELF æ–‡ä»¶å°†ä½äº `tests/asmtst/src/`ã€‚

*   **ç”Ÿæˆå¼•å¯¼ ROM (ç”¨äºä»¿çœŸå™¨):**
    æ„å»ºä»¿çœŸå™¨æ‰€éœ€çš„èµ„æºï¼Œå¦‚ `boot.elf`ã€‚
    ```bash
    make gen-rom
    ```
    è¾“å‡ºå°†ä½äº `emulator/assets/`ã€‚

*   **æ¸…ç†æ„å»ºäº§ç‰©:**
    ```bash
    make clean
    ```

### ğŸš€ è¿è¡Œä»¿çœŸå’Œæµ‹è¯•

ä»¿çœŸåœ¨ **Docker å®¹å™¨å†…** è¿è¡Œï¼Œä»¿çœŸå™¨ `VMarkoRvCore` å¯ç›´æ¥åŠ è½½ ELF æ–‡ä»¶ã€‚

#### 1. è¿è¡Œè‡ªå®šä¹‰æ±‡ç¼–æµ‹è¯•ï¼ˆä½äº `tests/asmtests/src`ï¼‰ï¼š

    ```bash
    make build-simulator
    make build-sim-rom
    ```

    å¦‚éœ€ç¼–è¯‘ç‰¹å®šæ±‡ç¼–æµ‹è¯•ï¼š

    ```bash
    make tests/asmtests/src/your_test_name.elf   # æˆ–ä½¿ç”¨ 'make build-test-elves' ç¼–è¯‘å…¨éƒ¨
    ```

    è¿è¡Œæ¨¡æ‹Ÿå™¨ï¼š

    ```bash
    obj_dir/VMarkoRvCore --rom-path emulator/assets/boot.elf --ram-path tests/asmtests/src/your_test_name.elf
    ```

    å¯ç”¨ `--help` æŸ¥çœ‹æ¨¡æ‹Ÿå™¨æ”¯æŒçš„å…¨éƒ¨å‚æ•°ã€‚

#### 2. è¿è¡Œ RISC-V å®˜æ–¹ ISA æµ‹è¯•ï¼ˆ`tests/riscv-tests`ï¼‰ï¼š

    è¿™äº›æµ‹è¯•ä½¿ç”¨è„šæœ¬ `batched_test.py` æ‰¹é‡è¿è¡Œã€‚è¿è¡Œå‰ç¡®ä¿ä»¿çœŸå™¨å’Œ boot ROM æ„å»ºå®Œæˆï¼š

    ```bash
    make build-simulator
    make build-sim-rom
    ```

    è¿è¡Œè„šæœ¬ï¼š

    ```bash
    python3 scripts/batched_test.py -j $(nproc)
    ```

    æ­¤è„šæœ¬ä¼šè‡ªåŠ¨æµ‹è¯• `riscv-tests/isa/` ä¸­çš„æ‰€æœ‰å¯ç”¨çš„ ELF æ–‡ä»¶ï¼Œè¾“å‡ºæ¯ä¸ªç”¨ä¾‹çš„ PASSED/FAILED çŠ¶æ€ã€‚

### ğŸ› ï¸ Makefile å¯ç”¨å‘½ä»¤ç®€è¡¨

| å‘½ä»¤åç§°                | åŠŸèƒ½æè¿° |
|------------------------|-----------|
| `make init`            | åˆå§‹åŒ–å­æ¨¡å—ï¼Œæ„å»º Capstone |
| `make build-simulator` | æ„å»º RISC-V ä»¿çœŸå™¨ |
| `make build-test-elves`| ç¼–è¯‘æµ‹è¯• ELF æ–‡ä»¶ |
| `make build-sim-rom`   | æ„å»ºä»¿çœŸå™¨ä½¿ç”¨çš„ ROM æ–‡ä»¶ |
| `make clean-all`       | æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰© |
| `make batched-riscv-tests` | æ‰¹é‡è¿è¡Œ RISC-V ISA æµ‹è¯• |
| `make exit`            | é€€å‡º CLI å·¥å…·ï¼ˆå¦‚æœä½¿ç”¨ CLI ç®¡ç†ï¼‰ |

### ğŸ“œ å†…å­˜é¡ºåºå®šä¹‰
*ä»…é™æš‚æ—¶çš„å†…å­˜é¡ºåºå®šä¹‰ã€‚* ä¸ä¿è¯ç¼“å­˜å†™å›é¡ºåºï¼Œä½†ä¿è¯ä»»æ„æŒ‡ä»¤å¯¹ CPU å†…éƒ¨çŠ¶æ€å½±å“çš„é¡ºåºä¸€è‡´æ€§ï¼ˆéä¹±åºæ‰§è¡Œï¼‰ã€‚

### ğŸ—ºï¸ æ›´æ–°è·¯çº¿
è¯·å‚é˜… [TODO.md](./TODO.md) æŸ¥çœ‹æœªæ¥çš„æ›´æ–°è®¡åˆ’ã€‚

### ğŸ›ï¸ æ¶æ„ä¸æ›´æ–°æ—¥å¿—
åœ¨ [docs](./docs) æ–‡ä»¶å¤¹ä¸­äº†è§£è¯¦ç»†çš„æ¶æ„ä¸æ›´æ–°æ—¥å¿—ã€‚